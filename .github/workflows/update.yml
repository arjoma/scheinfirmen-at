name: Daten Aktualisieren

on:
  schedule:
    # 2:15 AM UTC = 3:15 AM CET (winter) / 4:15 AM CEST (summer)
    # Using 15 past the hour to avoid peak load delays on GitHub Actions
    - cron: "15 2 * * *"
  workflow_dispatch:  # Allow manual trigger for testing

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Full history needed for STATS.md git-based analysis
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.12

      - name: Install package
        run: uv sync

      - name: Download, validate, and convert Scheinfirmen data
        run: uv run scheinfirmen-at --output-dir data/ --stats data/STATS.md --verbose

      - name: Extract Stand timestamp (fails if not present)
        id: stand
        run: |
          # Extract from JSONL metadata line
          STAND=$(grep '"_metadata"' data/scheinfirmen.jsonl | sed 's/.*"stand": "\([^"]*\)".*/\1/')
          if [ -z "$STAND" ]; then
            echo "ERROR: Could not extract Stand timestamp from data/scheinfirmen.jsonl" >&2
            exit 1
          fi
          echo "value=$STAND" >> "$GITHUB_OUTPUT"

      - name: Check for changes in data/ (ignore timestamp-only changes)
        id: changes
        run: |
          git diff \
            -I '"stand":' \
            -I '"_metadata"' \
            -I "<scheinfirmen " \
            --quiet -- data/ ':!data/STATS.md' \
            && echo "changed=false" >> "$GITHUB_OUTPUT" \
            || echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Commit and push updated data
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git commit -m "Update Scheinfirmen data (Stand: ${{ steps.stand.outputs.value }})"
          git push

      - name: No changes detected
        if: steps.changes.outputs.changed == 'false'
        run: |
          echo "Data is already up to date (Stand: ${{ steps.stand.outputs.value }})"
